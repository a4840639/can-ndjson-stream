<script src="../node_modules/steal/steal.js" main="@empty">
var ndjsonStream = require("can-ndjson-stream");

function streamerr(e) {
  console.warn("Stream error");
  console.warn(e);
}

fetch("/api").then( (response) => { 
  return ndjsonStream( response.body );
 }).then(function (todosStream) { 
  var reader = todosStream.getReader();
  reader.read().then(function read(result){
    if (result.done) {
      console.log("Done.");
      return;
    }
    console.log(result.value);
    render(result.value);
    
    reader.read().then(read, streamerr);
  }, streamerr);
 });

var counter = 0;

function render(val) {
  var div = document.createElement('div');
  div.append('Fetched ndjson row ', ++counter, ' : ', JSON.stringify(val));
  document.getElementsByTagName('body')[0].append(div);
}
</script>
